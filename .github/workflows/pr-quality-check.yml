name: PR Quality Check

# Workflow otimizado para Pull Requests
# Executa verificaÃ§Ãµes essenciais rapidamente
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  quick-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache dependÃªncias
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Executar testes da aplicaÃ§Ã£o tarefas
      run: |
        python manage.py test tarefas --verbosity=2 --keepdb
    
    - name: Verificar se hÃ¡ migraÃ§Ãµes pendentes
      run: |
        python manage.py makemigrations --check --dry-run
    
    - name: Comentar resultado no PR
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // Remove comentÃ¡rios anteriores do bot
          for (const comment of comments) {
            if (comment.user.type === 'Bot' && comment.body.includes('ğŸ§ª Resultado dos Testes')) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }
          }
          
          const success = '${{ job.status }}' === 'success';
          const emoji = success ? 'âœ…' : 'âŒ';
          const status = success ? 'PASSOU' : 'FALHOU';
          
          const body = `ğŸ§ª **Resultado dos Testes** ${emoji}
          
**Status:** ${status}

${success ? 
  'âœ… Todos os testes passaram! O PR estÃ¡ pronto para revisÃ£o.' : 
  'âŒ Alguns testes falharam. Verifique os logs do workflow para mais detalhes.'
}

**Testes executados:**
- âœ… Testes de modelos (Tarefa, Categoria)
- âœ… Testes de views (CRUD operations)
- âœ… Testes de formulÃ¡rios (ValidaÃ§Ãµes)
- âœ… Testes de busca e filtros
- âœ… VerificaÃ§Ã£o de migraÃ§Ãµes

**PrÃ³ximos passos:**
${success ? 
  '- ğŸ‘€ Aguarde a revisÃ£o do cÃ³digo\n- ğŸš€ ApÃ³s aprovaÃ§Ã£o, faÃ§a o merge' : 
  '- ğŸ”§ Corrija os testes que falharam\n- ğŸ“ FaÃ§a commit das correÃ§Ãµes\n- ğŸ”„ O workflow executarÃ¡ automaticamente'
}`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: body
          });

  # VerificaÃ§Ã£o de arquivos alterados
  file-changes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Verificar arquivos alterados
      run: |
        echo "ğŸ“ Arquivos alterados neste PR:"
        git diff --name-only origin/main...HEAD
        
        echo ""
        echo "ğŸ§ª Verificando se testes foram afetados..."
        
        # Verifica se models.py foi alterado
        if git diff --name-only origin/main...HEAD | grep -q "models.py"; then
          echo "âš ï¸  models.py foi alterado - certifique-se de que os testes de modelo estÃ£o atualizados"
        fi
        
        # Verifica se views.py foi alterado
        if git diff --name-only origin/main...HEAD | grep -q "views.py"; then
          echo "âš ï¸  views.py foi alterado - certifique-se de que os testes de view estÃ£o atualizados"
        fi
        
        # Verifica se forms.py foi alterado
        if git diff --name-only origin/main...HEAD | grep -q "forms.py"; then
          echo "âš ï¸  forms.py foi alterado - certifique-se de que os testes de formulÃ¡rio estÃ£o atualizados"
        fi
        
        # Verifica se requirements.txt foi alterado
        if git diff --name-only origin/main...HEAD | grep -q "requirements.txt"; then
          echo "ğŸ“¦ requirements.txt foi alterado - novas dependÃªncias serÃ£o instaladas"
        fi
